---
title: 基于自架的PushDeer实现手机推送功能
categories:
  - Dev
tags:
  - Python
index_img: 'https://blog-cnd-1307088890.cos.ap-guangzhou.myqcloud.com/202301031037568.png'
abbrlink: e614b7d0
date: 2023-01-03 10:31:43
---

<!-- more -->
<!-- categories:Dev、Ops、Study、Sth、News、work-->
<!-- tags: 
Python、MySQL、LeetCode、机器学习、Linux、Big Data、Java、BlockChain、Docker、Web 、分布式、
Maven、数据结构、JVM、JavaScript、Crontab、Shell、Ubuntu、VPN、NodeJS、String、VM、Hadoop、
Life、树莓派、Git、Hexo、算法、运维、网络、看法、电影、美学、写作、哲学、文档、绘画、前端、
历史、政治、社会、导购
 -->
官方的网址：https://www.pushdeer.com/selfhosted.html

实现流程：在本地通过docker部署服务端，启动后可通过IP/域名访问服务即可.

我的环境：Ubuntu18.04 LTS

## 安装Docker

**卸载旧版本**

```
sudo apt-get remove docker \
               docker-engine \
               docker.io
```

**使用https传输，并检查CA证书**

```
sudo apt-get update

sudo apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg \
    lsb-release
```

**添加软件源密钥**

```
curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
```

**添加稳定版 Docker APT镜像源**

```
echo \
  "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://mirrors.aliyun.com/docker-ce/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

**安装docker**

```
sudo apt-get update

sudo apt-get install docker-ce docker-ce-cli containerd.io
```

**启动docker**

```
sudo systemctl enable docker
sudo systemctl start docker
```

建立docker用户组，并将当前用户加入用户组

```
sudo groupadd docker

sudo usermod -aG docker $USER
```

**退出终端并重新登录，测试是否安装正确**

如执行完`docker run --rm hello-world`后出现如下输出，则docker已正确安装

```
docker run --rm hello-world

Unable to find image 'hello-world:latest' locally
latest: Pulling from library/hello-world
b8dfde127a29: Pull complete
Digest: sha256:308866a43596e83578c7dfa15e27a73011bdd402185a84c5cd7f32a88b501a24
Status: Downloaded newer image for hello-world:latest

Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
    (amd64)
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
 $ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/get-started/
```



## 安装docker-compose

下载compose文件到`/usr/local/bin`中

```
sudo curl -L "https://github.com/docker/compose/releases/download/v2.6.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
```

修改文件为可执行权限

```
sudo chmod +x /usr/local/bin/docker-compose
```

验证版本

```
docker-compose --version
```

## 开启本地端口

该服务默认运行在8800端口（可修改`docker-compose.yml`调整端口），如果本地是云服务器，需要在安全组开启端口

![](https://blog-cnd-1307088890.cos.ap-guangzhou.myqcloud.com/202301030951207.png)

## 构建服务器端

**下载仓库至本地**

```
git clone https://gitee.com/easychen/pushdeer.git
```

**构建容器并后台启动**

```
cd pushdeer
docker-compose -f docker-compose.self-hosted.yml up --build -d
```

第一次构建时间较长，等待构建结束在浏览器访问`IP/域名:8800`即可

![](https://blog-cnd-1307088890.cos.ap-guangzhou.myqcloud.com/202301030954337.png)

**后台查看进程**

```
docker-compose ps
```

![](https://blog-cnd-1307088890.cos.ap-guangzhou.myqcloud.com/202301031004289.png)

**实时查看日志**

```
docker-compose logs -f app
```

![](https://blog-cnd-1307088890.cos.ap-guangzhou.myqcloud.com/202301031003081.png)

**停止所有容器**

```
docker-compose down
```

IOS14+系统摄像头扫码可打开手机上的轻App，轻App中需要填写API endpoint，内容就是`IP/域名:8800`。进入轻App后需要注册设备，Key是自动生成的。接下来就可以直接进行测试了。建议是直接在AppStore中下载自架版PushDeer，轻App会在30天未使用后自动删除，到时候需要重置一些东西，比较麻烦。

## 推送消息

### 推送文字

```
http://121.5.20.90:8800/message/push?pushkey=$Key$&text=$text$
```

**地址栏填写内容**

![](https://blog-cnd-1307088890.cos.ap-guangzhou.myqcloud.com/202301031013440.png)

![](https://blog-cnd-1307088890.cos.ap-guangzhou.myqcloud.com/202301031017837.png)



**Python requests实现**

![](https://blog-cnd-1307088890.cos.ap-guangzhou.myqcloud.com/202301031014043.jpg)

![](https://blog-cnd-1307088890.cos.ap-guangzhou.myqcloud.com/202301031020501.jpg)



### 推送图片

![](https://blog-cnd-1307088890.cos.ap-guangzhou.myqcloud.com/202301031029856.png)

![](https://blog-cnd-1307088890.cos.ap-guangzhou.myqcloud.com/202301031030638.jpg)



**推送markdown**

````
https://api2.pushdeer.com/message/push?pushkey=$Key$&text=标题&desp=<markdown>&type=markdown
````

需要注意的是，VScode在闲置的时候好像会自行对代码中的连接发送请求，导致我手机重复收到推送。建议将其做成工具，这样就可以直接调用了。

